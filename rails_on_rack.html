<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Rails on Rack - Rails 指南</title>
    <meta name="viewport" content="width=device-width" />
    <script src="http://docs-china.com/rails/scripts/docs.js"></script>
    <link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="http://docs-china.com/rails/scripts/docs.css" />
</head>
<body>
    <a class="sr-only" href="#content">跳到正文</a>

    <nav class="navbar navbar-static-top docs-nav" id="top">
        <div class="container">
            <div class="navbar-header">
                <a href="http://docs-china.com" class="navbar-brand" title="回到首页">&larr; Docs China</a>
            </div>
        </div>
    </nav>

    <header class="header" role="banner">
        <div class="container">
            <h1 class="logo"><a href="http://docs-china.com/rails/" title="Rails 指南">Rails 指南</a></h1>
            
            <iframe src="http://ghbtns.com/github-btn.html?user=docs-china&repo=rails&type=fork&count=false"
  allowtransparency="true" frameborder="0" scrolling="0" width="62" height="20"></iframe>
            
            <div class="menu-mobile visible-xs">
  <select onchange="if (this.value) window.location.href=this.value">
    <option value="">目录</option>
    
    <optgroup label="起跑">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/getting_started.html">Rails 入门</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    
    <optgroup label="模型">
      


  

  
    
  
    
  
    
  
    
  
    
      <option value="/active_record_basics.html">Active Record 基础</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/migrations.html">Active Record 数据库迁移</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/active_record_validations.html">Active Record 数据验证</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/active_record_callbacks.html">Active Record 回调</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/association_basics.html">Active Record 关联</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/active_record_querying.html">Active Record 查询</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    
    <optgroup label="视图">
      


  

  
    
  
    
  
    
  
    
      <option value="/action_view_overview.html">Action View 基础</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/layouts_and_rendering.html">Layouts and Rendering in Rails</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/form_helpers.html">表单帮助方法</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    
    <optgroup label="控制器">
      


  

  
    
  
    
      <option value="/action_controller_overview.html">Action Controller 简介</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/routing.html">Rails 路由全解</option>
    
  
    
  
    
  
    
  


    </optgroup>
    
    <optgroup label="深入">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/active_support_core_extensions.html">Active Support 核心扩展</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/i18n.html">Rails 国际化 API</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
      <option value="/action_mailer_basics.html">Action Mailer 基础</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/testing.html">Rails 程序测试指南</option>
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/security.html">Ruby on Rails 安全指南</option>
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/debugging_rails_applications.html">Rails 程序调试</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/configuring.html">Rails 程序设置</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/command_line.html">Rails 命令行</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/caching_with_rails.html">Caching with Rails An overview</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/asset_pipeline.html">Asset Pipeline</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</option>
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/engines.html">Getting Started with Engines</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/initialization.html">Rails 初始化过程</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    
    <optgroup label="扩展">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/plugins.html">Rails 插件开发基础</option>
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/rails_on_rack.html">Rails on Rack</option>
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <option value="/generators.html">Creating and Customizing Rails Generators & Templates</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    
  </select>
</div>

        </div>
    </header>

    <div id="content" class="content" role="main">
        <div class="container">
            <div class="row">
                <main class="main col-sm-9 col-md-9">
                    <article class="entry">
                        <h1>Rails on Rack</h1>
                        <p>本文介绍 Rails 和 Rack 的集成，以及与其他 Rack 组件的配合。</p>

<p>本完后，你将学会：</p>

<ul>
  <li>如何在 Rails 程序中使用中间件；</li>
  <li>Action Pack 内建的中间件；</li>
  <li>如何编写中间件；</li>
</ul>

<hr />

          <div class="box warning-box">
  <p>阅读本文之前需要了解 Rack 协议及相关概念，如中间件、URL 映射和 <code>Rack::Builder</code>。</p>
</div>


<h2 id="introduction-to-rack">Rack 简介</h2>

<p>Rack 为使用 Ruby 开发的网页程序提供了小型模块化，适应性极高的接口。Rack 尽量使用最简单的方式封装 HTTP 请求和响应，为服务器、框架和二者之间的软件（中间件）提供了统一的 API，只要调用一个简单的方法就能完成一切操作。</p>

<ul>
  <li><a href="http://rack.rubyforge.org/doc/">Rack API 文档</a></li>
</ul>

<p>详细解说 Rack 不是本文的目的，如果不知道 Rack 基础知识，可以阅读“<a href="#resources">参考资源</a>”一节。</p>

<h2 id="rails-on-rack-section">Rails on Rack</h2>

<h3 id="rails-application-s-rack-object">Rails 程序中的 Rack 对象</h3>

<p><code>ApplicationName::Application</code> 是 Rails 程序中最主要的 Rack 程序对象。任何支持 Rack 的服务器都应该使用 <code>ApplicationName::Application</code> 对象服务 Rails 程序。<code>Rails.application</code> 也指向 <code>ApplicationName::Application</code> 对象。</p>

<h3 id="rails-server"><code>rails server</code></h3>

<p><code>rails server</code> 命令会创建 <code>Rack::Server</code> 对象并启动服务器。</p>

<p><code>rails server</code> 创建 <code>Rack::Server</code> 实例的方法如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="no">Rails</span><span class="o">::</span><span class="no">Server</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
  <span class="nb">require</span> <span class="no">APP_PATH</span>
  <span class="no">Dir</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">root</span><span class="p">)</span>
  <span class="n">server</span><span class="p">.</span><span class="nf">start</span>
<span class="k">end</span>
</pre>

</div><p><code>Rails::Server</code> 继承自 <code>Rack::Server</code>，使用下面的方式调用 <code>Rack::Server#start</code> 方法：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Server</span>
  <span class="k">def</span> <span class="nf">start</span>
    <span class="p">.</span><span class="nf">.</span><span class="o">.</span>
    <span class="k">super</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p><code>Rails::Server</code> 加载中间件的方式如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">def</span> <span class="nf">middleware</span>
  <span class="n">middlewares</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="n">middlewares</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Debugger</span><span class="o">]</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:debugger</span><span class="o">]</span>
  <span class="n">middlewares</span> <span class="o">&lt;&lt;</span> <span class="o">[::</span><span class="no">Rack</span><span class="o">::</span><span class="no">ContentLength</span><span class="o">]</span>
  <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">middlewares</span><span class="p">)</span>
<span class="k">end</span>
</pre>

</div>
<p><code>Rails::Rack::Debugger</code> 基本上只在开发环境中有用。下表说明了加载的各中间件的用途：</p>

<div class="table-responsive"><table>
  <thead>
    <tr>
      <th>中间件</th>
      <th>用途</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Rails::Rack::Debugger</code></td>
      <td>启用调试功能</td>
    </tr>
    <tr>
      <td><code>Rack::ContentLength</code></td>
      <td>计算响应的长度，单位为字节，然后设置 HTTP Content-Length 报头</td>
    </tr>
  </tbody>
</table>
</div>
<h3 id="rackup"><code>rackup</code></h3>

<p>如果想用 <code>rackup</code> 代替 <code>rails server</code> 命令，可以在 Rails 程序根目录下的 <code>config.ru</code> 文件中写入下面的代码：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="c1"># Rails.root/config.ru</span>
<span class="nb">require</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../config/environment'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span>

<span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Debugger</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ContentLength</span>
<span class="n">run</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span>
</pre>

</div>
<p>然后使用下面的命令启动服务器：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rackup config.ru
</pre>

</div>
<p>查看 <code>rackup</code> 的其他选项，可以执行下面的命令：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rackup --help
</pre>

</div>
<h2 id="action-dispatcher-middleware-stack">Action Dispatcher 中间件</h2>

<p>Action Dispatcher 中的很多组件都以 Rack 中间件的形式实现。<code>Rails::Application</code> 通过 <code>ActionDispatch::MiddlewareStack</code> 把内部和外部的中间件组合在一起，形成一个完整的 Rails Rack 程序。</p>

          <div class="box information-box">
  <p>在 Rails 中，<code>ActionDispatch::MiddlewareStack</code> 的作用和 <code>Rack::Builder</code> 一样，不过前者更灵活，也为满足 Rails 的需求加入了更多功能。</p>
</div>


<h3 id="inspecting-middleware-stack">查看使用的中间件</h3>

<p>Rails 提供了一个 rake 任务，用来查看使用的中间件：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rake middleware
</pre>

</div>
<p>在新建的 Rails 程序中，可能会输出如下结果：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Sendfile</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Static</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Lock</span>
<span class="n">use</span> <span class="c1">#&lt;ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x000000029a0838&gt;</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Runtime</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">MethodOverride</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">RequestId</span>
<span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Logger</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">ShowExceptions</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">DebugExceptions</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">RemoteIp</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Reloader</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Callbacks</span>
<span class="n">use</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">::</span><span class="no">CheckPending</span>
<span class="n">use</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">ConnectionAdapters</span><span class="o">::</span><span class="no">ConnectionManagement</span>
<span class="n">use</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">QueryCache</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Cookies</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">CookieStore</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span>
<span class="n">use</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">ParamsParser</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Head</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ConditionalGet</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">ETag</span>
<span class="n">run</span> <span class="no">MyApp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">routes</span>
</pre>

</div>
<p>这里列出的各中间件在“<a href="#internal-middleware-stack">内部中间件</a>”一节有详细介绍。</p>

<h3 id="configuring-middleware-stack">设置中间件</h3>

<p>Rails 在 <code>application.rb</code> 和 <code>environments/&lt;environment&gt;.rb</code> 文件中提供了一个简单的设置项 <code>config.middleware</code>，可以添加新中间件，删除再用的中间件，或者修改中间件的加载顺序。</p>

<h4 id="adding-a-middleware">添加新中间件</h4>

<p>使用下面列出的任何一种方法都可以添加新中间件：</p>

<ul>
  <li><code>config.middleware.use(new_middleware, args)</code>：把新中间件添加到列表末尾；</li>
  <li><code>config.middleware.insert_before(existing_middleware, new_middleware, args)</code>：在 <code>existing_middleware</code> 之前添加新中间件；</li>
  <li><code>config.middleware.insert_after(existing_middleware, new_middleware, args)</code>：在 <code>existing_middleware</code> 之后添加新中间件；</li>
</ul>

<div class="codeblock ruby"><pre class="highlight"><span class="c1"># config/application.rb</span>

<span class="c1"># Push Rack::BounceFavicon at the bottom</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">BounceFavicon</span>

<span class="c1"># Add Lifo::Cache after ActiveRecord::QueryCache.</span>
<span class="c1"># Pass { page_cache: false } argument to Lifo::Cache.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_after</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">QueryCache</span><span class="p">,</span> <span class="no">Lifo</span><span class="o">::</span><span class="no">Cache</span><span class="p">,</span> <span class="ss">page_cache: </span><span class="kp">false</span>
</pre>

</div>
<h4 id="swapping-a-middleware">替换中间件</h4>

<p>使用 <code>config.middleware.swap</code> 可以替换现有的中间件：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="c1"># config/application.rb</span>

<span class="c1"># Replace ActionDispatch::ShowExceptions with Lifo::ShowExceptions</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">swap</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">ShowExceptions</span><span class="p">,</span> <span class="no">Lifo</span><span class="o">::</span><span class="no">ShowExceptions</span>
</pre>

</div>
<h4 id="deleting-a-middleware">删除中间件</h4>

<p>在程序的设置文件中加入下面的代码：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">delete</span> <span class="s2">"Rack::Lock"</span>
</pre>

</div>
<p>现在查看所用的中间件，会发现 <code>Rack::Lock</code> 不在输出结果中。</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rake middleware
<span class="o">(</span><span class="k">in</span> /Users/lifo/Rails/blog<span class="o">)</span>
use ActionDispatch::Static
use <span class="c">#&lt;ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x00000001c304c8&gt;</span>
use Rack::Runtime
...
run Blog::Application.routes
</pre>

</div>
<p>如果想删除会话相关的中间件，可以这么做：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">delete</span> <span class="s2">"ActionDispatch::Cookies"</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">delete</span> <span class="s2">"ActionDispatch::Session::CookieStore"</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">delete</span> <span class="s2">"ActionDispatch::Flash"</span>
</pre>

</div>
<p>删除浏览器相关的中间件：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">delete</span> <span class="s2">"Rack::MethodOverride"</span>
</pre>

</div>
<h3 id="internal-middleware-stack">内部中间件</h3>

<p>Action Controller 的很多功能都以中间件的形式实现。下面解释个中间件的作用。</p>

<p><strong><code>Rack::Sendfile</code></strong>：设置服务器上的 X-Sendfile 报头。通过 <code>config.action_dispatch.x_sendfile_header</code> 选项设置。</p>

<p><strong><code>ActionDispatch::Static</code></strong>：用来服务静态资源文件。如果选项 <code>config.serve_static_assets</code> 为 <code>false</code>，则禁用这个中间件。</p>

<p><strong><code>Rack::Lock</code></strong>：把 <code>env["rack.multithread"]</code> 旗标设为 <code>false</code>，程序放入互斥锁中。</p>

<p><strong><code>ActiveSupport::Cache::Strategy::LocalCache::Middleware</code></strong>：在内存中保存缓存，非线程安全。</p>

<p><strong><code>Rack::Runtime</code></strong>：设置 X-Runtime 报头，即执行请求的时长，单位为秒。</p>

<p><strong><code>Rack::MethodOverride</code></strong>：如果指定了 <code>params[:_method]</code> 参数，会覆盖所用的请求方法。这个中间件实现了 PUT 和 DELETE 方法。</p>

<p><strong><code>ActionDispatch::RequestId</code></strong>：在响应中设置一个唯一的 X-Request-Id 报头，并启用 <code>ActionDispatch::Request#uuid</code> 方法。</p>

<p><strong><code>Rails::Rack::Logger</code></strong>：请求开始时提醒日志，请求完成后写入日志。</p>

<p><strong><code>ActionDispatch::ShowExceptions</code></strong>：补救程序抛出的所有异常，调用处理异常的程序，使用特定的格式显示给用户。</p>

<p><strong><code>ActionDispatch::DebugExceptions</code></strong>：如果在本地开发，把异常写入日志，并显示一个调试页面。</p>

<p><strong><code>ActionDispatch::RemoteIp</code></strong>：检查欺骗攻击的 IP。</p>

<p><strong><code>ActionDispatch::Reloader</code></strong>：提供“准备”和“清理”回调，协助开发环境中的代码重新加载功能。</p>

<p><strong><code>ActionDispatch::Callbacks</code></strong>：在处理请求之前调用“准备”回调。</p>

<p><strong><code>ActiveRecord::Migration::CheckPending</code></strong>：检查是否有待运行的迁移，如果有就抛出 <code>ActiveRecord::PendingMigrationError</code> 异常。</p>

<p><strong><code>ActiveRecord::ConnectionAdapters::ConnectionManagement</code></strong>：请求处理完成后，清理活跃的连接，除非在发起请求的环境中把 <code>rack.test</code> 设为 <code>true</code>。</p>

<p><strong><code>ActiveRecord::QueryCache</code></strong>：启用 Active Record 查询缓存。</p>

<p><strong><code>ActionDispatch::Cookies</code></strong>：设置请求的 cookies。</p>

<p><strong><code>ActionDispatch::Session::CookieStore</code></strong>：负责把会话存储在 cookies 中。</p>

<p><strong><code>ActionDispatch::Flash</code></strong>：设置 Flash 消息的键。只有设定了 <code>config.action_controller.session_store</code> 选项时才可用。</p>

<p><strong><code>ActionDispatch::ParamsParser</code></strong>：把请求中的参数出入 <code>params</code>。</p>

<p><strong><code>ActionDispatch::Head</code></strong>：把 HEAD 请求转换成 GET 请求，并处理。</p>

<p><strong><code>Rack::ConditionalGet</code></strong>：添加对“条件 GET”的支持，如果页面未修改，就不响应。</p>

<p><strong><code>Rack::ETag</code></strong>：为所有字符串类型的主体添加 ETags 报头。ETags 用来验证缓存。</p>

          <div class="box tip-box">
  <p>设置 Rack 时可使用上述任意一个中间件。</p>
</div>


<h1 id="resources">参考资源</h1>

<h3 id="learning-rack">学习</h3>

<ul>
  <li><a href="http://rack.github.io">Rack 官网</a></li>
  <li><a href="http://chneukirchen.org/blog/archive/2007/02/introducing-rack.html">Rack 简介</a></li>
  <li><a href="http://m.onkey.org/ruby-on-rack-1-hello-rack">Ruby on Rack #1 - Hello Rack!</a></li>
  <li><a href="http://m.onkey.org/ruby-on-rack-2-the-builder">Ruby on Rack #2 - The Builder</a></li>
</ul>

<h3 id="understanding-middlewares">理解中间件</h3>

<ul>
  <li><a href="http://railscasts.com/episodes/151-rack-middleware">Railscast 介绍 Rack 中间件的视频</a></li>
</ul>

                    </article>
                    <div class="section-nav clearfix">
  <div class="pull-left">
    
      <a href="http://docs-china.com/rails/plugins.html" class="prev">
        &laquo;前一篇
      </a>
    
  </div>
  <div class="pull-right">
    
      <a href="http://docs-china.com/rails/generators.html" class="next">
        后一篇&raquo;
      </a>
    
  </div>
</div>

                </main>
                <div class="sidebar col-sm-3 col-md-3 hidden-xs">
                    <aside class="ebook">
    <h4>电子书</h4>
    <p><a href="https://leanpub.com/rails-guides-cn" title="Rails 指南"><img src="http://docs-china.com/rails/images/book_cover.png" width="127" height="164" alt="Rails 指南" /></a>
    <p>pdf + epub + mobi 全平台支持</p>
</aside>

<aside class="menu">
    
    <h4>起跑</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/getting_started.html">Rails 入门</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>模型</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_basics.html">Active Record 基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/migrations.html">Active Record 数据库迁移</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_validations.html">Active Record 数据验证</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_callbacks.html">Active Record 回调</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/association_basics.html">Active Record 关联</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_querying.html">Active Record 查询</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>视图</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/action_view_overview.html">Action View 基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/layouts_and_rendering.html">Layouts and Rendering in Rails</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/form_helpers.html">表单帮助方法</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>控制器</h4>
    

<ul>

  

  
    
  

  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/action_controller_overview.html">Action Controller 简介</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/routing.html">Rails 路由全解</a></li>
    
  
    
  
    
  
    
  


</ul>

    
    <h4>深入</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_support_core_extensions.html">Active Support 核心扩展</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/i18n.html">Rails 国际化 API</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/action_mailer_basics.html">Action Mailer 基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/testing.html">Rails 程序测试指南</a></li>
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/security.html">Ruby on Rails 安全指南</a></li>
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/debugging_rails_applications.html">Rails 程序调试</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/configuring.html">Rails 程序设置</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/command_line.html">Rails 命令行</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/caching_with_rails.html">Caching with Rails An overview</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/asset_pipeline.html">Asset Pipeline</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</a></li>
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/engines.html">Getting Started with Engines</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/initialization.html">Rails 初始化过程</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>扩展</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/plugins.html">Rails 插件开发基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class="current"><a href="http://docs-china.com/rails/rails_on_rack.html">Rails on Rack</a></li>
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/generators.html">Creating and Customizing Rails Generators & Templates</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
</aside>


                </div>
            </div>
        </div>
    </div>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <div>
                <ul class="social">
                    <li class="github">
                        <a href="https://github.com/docs-china/rails/" title="在 GitHub 上关注我们">Github</a>
                    </li>
                    <li class="weibo">
                        <a href="http://weibo.com/docschina" title="关注我们的微博">@DocsChina</a>
                    </li>
                </ul>
            </div>

            <p>本文档授权协议：<a href="http://creativecommons.org/licenses/by-sa/4.0/deed.zh" title="CC BY-SA 4.0">CC BY-SA 4.0</a></p>
        </div>
    </footer>
</body>
</html>
