<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Active Record 数据验证 - Rails 指南</title>
    <meta name="viewport" content="width=device-width" />
    <script src="http://docs-china.com/rails/scripts/docs.js"></script>
    <link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="http://docs-china.com/rails/scripts/docs.css" />
</head>
<body>
    <a class="sr-only" href="#content">跳到正文</a>

    <nav class="navbar navbar-static-top docs-nav" id="top">
        <div class="container">
            <div class="navbar-header">
                <a href="http://docs-china.com" class="navbar-brand" title="回到首页">&larr; Docs China</a>
            </div>
        </div>
    </nav>

    <header class="header" role="banner">
        <div class="container">
            <h1 class="logo"><a href="http://docs-china.com/rails/" title="Rails 指南">Rails 指南</a></h1>
            
            <iframe src="http://ghbtns.com/github-btn.html?user=docs-china&repo=&type=fork&count=false"
  allowtransparency="true" frameborder="0" scrolling="0" width="62" height="20"></iframe>
            
        </div>
    </header>

    <div id="content" class="content" role="main">
        <div class="container">
            <div class="row">
                <main class="main col-sm-9 col-md-9">
                    <article class="entry">
                        <h1>Active Record 数据验证</h1>
                        <p>本文介绍如何使用 Active Record 提供的数据验证功能在数据存入数据库之前验证对象的状态。</p>

<p>读完后，你将学会：</p>

<ul>
  <li>如何使用 Active Record 内建的数据验证帮助方法；</li>
  <li>如果编写自定义的数据验证方法；</li>
  <li>如何处理验证时产生的错误消息；</li>
</ul>

<hr />

<h2 id="validations-overview">数据验证简介</h2>

<p>下面演示一个非常简单的数据验证：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"John Doe"</span><span class="p">).</span><span class="nf">valid?</span> <span class="c1"># =&gt; true</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="kp">nil</span><span class="p">).</span><span class="nf">valid?</span> <span class="c1"># =&gt; false</span>
</pre>

</div>
<p>如上所示，如果 <code>Person</code> 没有 <code>name</code> 属性，验证就会将其视为不合法对象。创建的第二个 <code>Person</code> 对象不会存入数据库。</p>

<p>在深入探讨之前，我们先来介绍数据验证在整个程序中的作用。</p>

<h3 id="why-use-validations">为什么要做数据验证？</h3>

<p>数据验证能确保只有合法的数据才会存入数据库。例如，程序可能需要用户提供一个合法的 Email 地址和邮寄地址。在模型中做验证是最有保障的，只有通过验证的数据才能存入数据库。数据验证和使用的数据库种类无关，终端用户也无法跳过，而且容易测试和维护。在 Rails 中做数据验证很简单，Rails 内置了很多帮助方法，能满足常规的需求，而且还可以编写自定义的验证方法。</p>

<p>数据存入数据库之前的验证方法还有其他几种，包括数据库内建的约束，客户端验证和控制器层验证。下面列出了这几种验证方法的优缺点：</p>

<ul>
  <li>数据库约束和“存储过程”无法兼容多种数据库，而且测试和维护较为困难。不过，如果其他程序也要使用这个数据库，最好在数据库层做些约束。数据库层的某些验证（例如在使用量很高的数据表中做唯一性验证）通过其他方式实现起来有点困难。</li>
  <li>客户端验证很有用，但单独使用时可靠性不高。如果使用 JavaScript 实现，用户在浏览器中禁用 JavaScript 后很容易跳过验证。客户端验证和其他验证方式结合使用，可以为用户提供实时反馈。</li>
  <li>控制器层验证很诱人，但一般都不灵便，难以测试和维护。只要可能，就要保证控制器的代码简洁性，这样才有利于长远发展。</li>
</ul>

<p>你可以根据实际的需求选择使用哪种验证方式。Rails 团队认为，模型层数据验证最具普适性。</p>

<h3 id="when-does-validation-happen">什么时候做数据验证？</h3>

<p>在 Active Record 中对象有两种状态：一种在数据库中有对应的记录，一种没有。新建的对象（例如，使用 <code>new</code> 方法）还不属于数据库。在对象上调用 <code>save</code> 方法后，才会把对象存入相应的数据表。Active Record 使用实例方法 <code>new_record?</code> 判断对象是否已经存入数据库。加入有下面这个简单的 Active Record 类：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</pre>

</div>
<p>我们可以在 <code>rails console</code> 中看一下到底怎么回事：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="err">$</span> <span class="n">rails</span> <span class="n">console</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"John Doe"</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Person id: nil, name: "John Doe", created_at: nil, updated_at: nil&gt;</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="p">.</span><span class="nf">new_record?</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="p">.</span><span class="nf">save</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="p">.</span><span class="nf">new_record?</span>
<span class="o">=&gt;</span> <span class="kp">false</span>
</pre>

</div>
<p>新建并保存记录会在数据库中执行 SQL <code>INSERT</code> 操作。更新现有的记录会在数据库上执行 SQL <code>UPDATE</code> 操作。一般情况下，数据验证发生在这些 SQL 操作执行之前。如果验证失败，对象会被标记为不合法，Active Record 不会向数据库发送 <code>INSERT</code> 或 <code>UPDATE</code> 指令。这样就可以避免把不合法的数据存入数据库。你可以选择在对象创建、保存或更新时执行哪些数据验证。</p>

          <div class="box warning-box">
  <p>修改数据库中对象的状态有很多方法。有些方法会做数据验证，有些则不会。所以，如果不小心处理，还是有可能把不合法的数据存入数据库。</p>
</div>


<p>下列方法会做数据验证，如果验证失败就不会把对象存入数据库：</p>

<ul>
  <li><code>create</code></li>
  <li><code>create!</code></li>
  <li><code>save</code></li>
  <li><code>save!</code></li>
  <li><code>update</code></li>
  <li><code>update!</code></li>
</ul>

<p>爆炸方法（例如 <code>save!</code>）会在验证失败后抛出异常。验证失败后，非爆炸方法不会抛出异常，<code>save</code> 和 <code>update</code> 返回 <code>false</code>，<code>create</code> 返回对象本身。</p>

<h3 id="skipping-validations">跳过验证</h3>

<p>下列方法会跳过验证，不过验证是否通过都会把对象存入数据库，使用时要特别留意。</p>

<ul>
  <li><code>decrement!</code></li>
  <li><code>decrement_counter</code></li>
  <li><code>increment!</code></li>
  <li><code>increment_counter</code></li>
  <li><code>toggle!</code></li>
  <li><code>touch</code></li>
  <li><code>update_all</code></li>
  <li><code>update_attribute</code></li>
  <li><code>update_column</code></li>
  <li><code>update_columns</code></li>
  <li><code>update_counters</code></li>
</ul>

<p>注意，使用 <code>save</code> 时如果传入 <code>validate: false</code>，也会跳过验证。使用时要特别留意。</p>

<ul>
  <li><code>save(validate: false)</code></li>
</ul>

<h3 id="valid-questionmark-and-invalid-questionmark"><code>valid?</code> 和 <code>invalid?</code></h3>

<p>Rails 使用 <code>valid?</code> 方法检查对象是否合法。<code>valid?</code> 方法会触发数据验证，如果对象上没有错误，就返回 <code>true</code>，否则返回 <code>false</code>。前面我们已经用过了：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"John Doe"</span><span class="p">).</span><span class="nf">valid?</span> <span class="c1"># =&gt; true</span>
<span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="kp">nil</span><span class="p">).</span><span class="nf">valid?</span> <span class="c1"># =&gt; false</span>
</pre>

</div>
<p>Active Record 验证结束后，所有发现的错误都可以通过实例方法 <code>errors.messages</code> 获取，该方法返回一个错误集合。如果数据验证后，这个集合为空，则说明对象是合法的。</p>

<p>注意，使用 <code>new</code> 方法初始化对象时，即使不合法也不会报错，因为这时还没做数据验证。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="o">&gt;&gt;</span> <span class="nb">p</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="c1"># =&gt; #&lt;Person id: nil, name: nil&gt;</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">messages</span>
<span class="c1"># =&gt; {}</span>

<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="p">.</span><span class="nf">valid?</span>
<span class="c1"># =&gt; false</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">messages</span>
<span class="c1"># =&gt; {name:["can't be blank"]}</span>

<span class="o">&gt;&gt;</span> <span class="nb">p</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span>
<span class="c1"># =&gt; #&lt;Person id: nil, name: nil&gt;</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">messages</span>
<span class="c1"># =&gt; {name:["can't be blank"]}</span>

<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="p">.</span><span class="nf">save</span>
<span class="c1"># =&gt; false</span>

<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="p">.</span><span class="nf">save!</span>
<span class="c1"># =&gt; ActiveRecord::RecordInvalid: Validation failed: Name can't be blank</span>

<span class="o">&gt;&gt;</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create!</span>
<span class="c1"># =&gt; ActiveRecord::RecordInvalid: Validation failed: Name can't be blank</span>
</pre>

</div>
<p><code>invalid?</code> 是 <code>valid?</code> 的逆测试，会触发数据验证，如果找到错误就返回 <code>true</code>，否则返回 <code>false</code>。</p>

<h3 id="validations-overview-errors"><code>errors[]</code></h3>

<p>要检查对象的某个属性是否合法，可以使用 <code>errors[:attribute]</code>。<code>errors[:attribute]</code> 中包含 <code>:attribute</code> 的所有错误。如果某个属性没有错误，就会返回空数组。</p>

<p>这个方法只在数据验证之后才能使用，因为它只是用来收集错误信息的，并不会触发验证。而且，和前面介绍的 <code>ActiveRecord::Base#invalid?</code> 方法不一样，因为 <code>errors[:attribute]</code> 不会验证整个对象，值检查对象的某个属性是否出错。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="o">&gt;&gt;</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">.</span><span class="nf">any?</span> <span class="c1"># =&gt; false</span>
<span class="o">&gt;&gt;</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">.</span><span class="nf">any?</span> <span class="c1"># =&gt; true</span>
</pre>

</div>
<p>我们会在“<a href="#working-with-validation-errors">处理验证错误</a>”一节详细介绍验证错误。现在，我们来看一下 Rails 默认提供的数据验证帮助方法。</p>

<h2 id="validation-helpers">数据验证帮助方法</h2>

<p>Active Record 预先定义了很多数据验证帮助方法，可以直接在模型类定义中使用。这些帮助方法提供了常用的验证规则。每次验证失败后，都会向对象的 <code>errors</code> 集合中添加一个消息，这些消息和所验证的属性是关联的。</p>

<p>每个帮助方法都可以接受任意数量的属性名，所以一行代码就能在多个属性上做同一种验证。</p>

<p>所有的帮助方法都可指定 <code>:on</code> 和 <code>:message</code> 选项，指定何时做验证，以及验证失败后向 <code>errors</code> 集合添加什么消息。<code>:on</code> 选项的可选值是 <code>:create</code> 和 <code>:update</code>。每个帮助函数都有默认的错误消息，如果没有通过 <code>:message</code> 选项指定，则使用默认值。下面分别介绍各帮助方法。</p>

<h3 id="acceptance"><code>acceptance</code></h3>

<p>这个方法检查表单提交时，用户界面中的复选框是否被选中。这个功能一般用来要求用户接受程序的服务条款，阅读一些文字，等等。这种验证只针对网页程序，不会存入数据库（如果没有对应的字段，该方法会创建一个虚拟属性）。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:terms_of_service</span><span class="p">,</span> <span class="ss">acceptance: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<p>这个帮助方法的默认错误消息是“must be accepted”。</p>

<p>这个方法可以指定 <code>:accept</code> 选项，决定可接受什么值。默认为“1”，很容易修改：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:terms_of_service</span><span class="p">,</span> <span class="ss">acceptance: </span><span class="p">{</span> <span class="ss">accept: </span><span class="s1">'yes'</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<h3 id="validates-associated"><code>validates_associated</code></h3>

<p>如果模型和其他模型有关联，也要验证关联的模型对象，可以使用这个方法。保存对象是，会在相关联的每个对象上调用 <code>valid?</code> 方法。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Library</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">validates_associated</span> <span class="ss">:books</span>
<span class="k">end</span>
</pre>

</div>
<p>这个帮助方法可用于所有关联类型。</p>

          <div class="box warning-box">
  <p>不要在关联的两端都使用 <code>validates_associated</code>，这样会生成一个循环。</p>
</div>


<p><code>validates_associated</code> 的默认错误消息是“is invalid”。注意，相关联的每个对象都有各自的 <code>errors</code> 集合，错误消息不会都集中在调用该方法的模型对象上。</p>

<h3 id="confirmation"><code>confirmation</code></h3>

<p>如果要检查两个文本字段的值是否完全相同，可以使用这个帮助方法。例如，确认 Email 地址或密码。这个帮助方法会创建一个虚拟属性，其名字为要验证的属性名后加 <code>_confirmation</code>。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">confirmation: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<p>在试图中可以这么写：</p>

<div class="codeblock erb"><pre class="highlight"><span class="cp">&lt;%=</span> <span class="n">text_field</span> <span class="ss">:person</span><span class="p">,</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">text_field</span> <span class="ss">:person</span><span class="p">,</span> <span class="ss">:email_confirmation</span> <span class="cp">%&gt;</span>
</pre>

</div>
<p>只有 <code>email_confirmation</code> 的值不是 <code>nil</code> 时才会做这个验证。所以要为确认属性加上存在性验证（后文会介绍 <code>presence</code> 验证）。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">confirmation: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email_confirmation</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<p>这个帮助方法的默认错误消息是“doesn’t match confirmation”。</p>

<h3 id="exclusion"><code>exclusion</code></h3>

<p>这个帮助方法检查属性的值是否不在指定的集合中。集合可以是任何一种可枚举的对象。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:subdomain</span><span class="p">,</span> <span class="ss">exclusion: </span><span class="p">{</span> <span class="k">in</span><span class="p">:</span> <span class="sx">%w(www us ca jp)</span><span class="p">,</span>
    <span class="ss">message: </span><span class="s2">"%{value} is reserved."</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<p><code>exclusion</code> 方法要指定 <code>:in</code> 选项，设置哪些值不能作为属性的值。<code>:in</code> 选项有个别名 <code>:with</code>，作用相同。上面的例子设置了 <code>:message</code> 选项，演示如何获取属性的值。</p>

<p>默认的错误消息是“is reserved”。</p>

<h3 id="format"><code>format</code></h3>

<p>这个帮助方法检查属性的值是否匹配 <code>:with</code> 选项指定的正则表达式。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:legacy_code</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with: </span><span class="o">/</span><span class="p">\</span><span class="n">A</span><span class="o">[</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="o">]+</span><span class="p">\</span><span class="n">z</span><span class="o">/</span><span class="p">,</span>
    <span class="ss">message: </span><span class="s2">"only allows letters"</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<p>默认的错误消息是“is invalid”。
The default error message is <em>“is invalid”</em>.</p>

<h3 id="inclusion"><code>inclusion</code></h3>

<p>这个帮助方法检查属性的值是否在指定的集合中。集合可以是任何一种可枚举的对象。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Coffee</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">inclusion: </span><span class="p">{</span> <span class="k">in</span><span class="p">:</span> <span class="sx">%w(small medium large)</span><span class="p">,</span>
    <span class="ss">message: </span><span class="s2">"%{value} is not a valid size"</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<p><code>inclusion</code> 方法要指定 <code>:in</code> 选项，设置可接受哪些值。<code>:in</code> 选项有个别名 <code>:within</code>，作用相同。上面的例子设置了 <code>:message</code> 选项，演示如何获取属性的值。</p>

<p>该方法的默认错误消息是“is not included in the list”。</p>

<h3 id="length"><code>length</code></h3>

<p>这个帮助方法验证属性值的长度，有多个选项，可以使用不同的方法指定长度限制：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">minimum: </span><span class="mi">2</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:bio</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">maximum: </span><span class="mi">500</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="k">in</span><span class="p">:</span> <span class="mi">6</span><span class="p">.</span><span class="nf">.</span><span class="mi">20</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:registration_number</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">is: </span><span class="mi">6</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<p>可用的长度限制选项有：</p>

<ul>
  <li><code>:minimum</code>：属性的值不能比指定的长度短；</li>
  <li><code>:maximum</code>：属性的值不能比指定的长度长；</li>
  <li><code>:in</code>（或 <code>:within</code>）：属性值的长度在指定值之间。该选项的值必须是一个范围；</li>
  <li><code>:is</code>：属性值的长度必须等于指定值；</li>
</ul>

<p>默认的错误消息根据长度验证类型而有所不同，还是可以 <code>:message</code> 定制。定制消息时，可以使用 <code>:wrong_length</code>、<code>:too_long</code> 和 <code>:too_short</code> 选项，<code>%{count}</code> 表示长度限制的值。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:bio</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">maximum: </span><span class="mi">1000</span><span class="p">,</span>
    <span class="ss">too_long: </span><span class="s2">"%{count} characters is the maximum allowed"</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<p>这个帮助方法默认统计字符数，但可以使用 <code>:tokenizer</code> 选项设置其他的统计方式：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Essay</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span>
    <span class="ss">minimum: </span><span class="mi">300</span><span class="p">,</span>
    <span class="ss">maximum: </span><span class="mi">400</span><span class="p">,</span>
    <span class="ss">tokenizer: </span><span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">str</span><span class="o">|</span> <span class="n">str</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="sr">/\w+/</span><span class="p">)</span> <span class="p">},</span>
    <span class="ss">too_short: </span><span class="s2">"must have at least %{count} words"</span><span class="p">,</span>
    <span class="ss">too_long: </span><span class="s2">"must have at most %{count} words"</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<p>注意，默认的错误消息使用复数形式（例如，“is too short (minimum is %{count} characters”），所以如果长度限制是 <code>minimum: 1</code>，就要提供一个定制的消息，或者使用 <code>presence: true</code> 代替。<code>:in</code> 或 <code>:within</code> 的值比 1 小时，都要提供一个定制的消息，或者在 <code>length</code> 之前，调用 <code>presence</code> 方法。</p>

<h3 id="numericality"><code>numericality</code></h3>

<p>这个帮助方法检查属性的值是否值包含数字。默认情况下，匹配的值是可选的正负符号后加整数或浮点数。如果只接受整数，可以把 <code>:only_integer</code> 选项设为 <code>true</code>。</p>

<p>如果 <code>:only_integer</code> 为 <code>true</code>，则使用下面的正则表达式验证属性的值。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="sr">/\A[+-]?\d+\Z/</span>
</pre>

</div>
<p>否则，会尝试使用 <code>Float</code> 把值转换成数字。</p>

          <div class="box warning-box">
  <p>注意上面的正则表达式允许最后出现换行符。</p>
</div>


<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Player</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:points</span><span class="p">,</span> <span class="ss">numericality: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:games_played</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">only_integer: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<p>除了 <code>:only_integer</code> 之外，这个方法还可指定以下选项，限制可接受的值：</p>

<ul>
  <li><code>:greater_than</code>：属性值必须比指定的值大。该选项默认的错误消息是“must be greater than %{count}”；</li>
  <li><code>:greater_than_or_equal_to</code>：属性值必须大于或等于指定的值。该选项默认的错误消息是“must be greater than or equal to %{count}”；</li>
  <li><code>:equal_to</code>：属性值必须等于指定的值。该选项默认的错误消息是“must be equal to %{count}”；</li>
  <li><code>:less_than</code>：属性值必须比指定的值小。该选项默认的错误消息是“must be less than %{count}”；</li>
  <li><code>:less_than_or_equal_to</code>：属性值必须小于或等于指定的值。该选项默认的错误消息是“must be less than or equal to %{count}”；</li>
  <li><code>:odd</code>：如果设为 <code>true</code>，属性值必须是奇数。该选项默认的错误消息是“must be odd”；</li>
  <li><code>:even</code>：如果设为 <code>true</code>，属性值必须是偶数。该选项默认的错误消息是“must be even”；</li>
</ul>

<p>默认的错误消息是“is not a number”。</p>

<h3 id="presence"><code>presence</code></h3>

<p>这个帮助方法检查指定的属性是否为非空值，调用 <code>blank?</code> 方法检查只是否为 <code>nil</code> 或空字符串，即空字符串或只包含空白的字符串。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:login</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<p>如果要确保关联对象存在，需要测试关联的对象本身是够存在，而不是用来映射关联的外键。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">LineItem</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:order</span>
  <span class="n">validates</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<p>为了能验证关联的对象是否存在，要在关联中指定 <code>:inverse_of</code> 选项。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:line_items</span><span class="p">,</span> <span class="ss">inverse_of: :order</span>
<span class="k">end</span>
</pre>

</div>
<p>如果验证 <code>has_one</code> 或 <code>has_many</code> 关联的对象是否存在，会在关联的对象上调用 <code>blank?</code> 和 <code>marked_for_destruction?</code> 方法。</p>

<p>因为 <code>false.blank?</code> 的返回值是 <code>true</code>，所以如果要验证布尔值字段是否存在要使用 <code>validates :field_name, inclusion: { in: [true, false] }</code>。</p>

<p>默认的错误消息是“can’t be blank”。</p>

<h3 id="absence"><code>absence</code></h3>

<p>这个方法验证指定的属性值是否为空，使用 <code>present?</code> 方法检测值是否为 <code>nil</code> 或空字符串，即空字符串或只包含空白的字符串。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:login</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">absence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<p>如果要确保关联对象为空，需要测试关联的对象本身是够为空，而不是用来映射关联的外键。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">LineItem</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:order</span>
  <span class="n">validates</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">absence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<p>为了能验证关联的对象是否为空，要在关联中指定 <code>:inverse_of</code> 选项。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:line_items</span><span class="p">,</span> <span class="ss">inverse_of: :order</span>
<span class="k">end</span>
</pre>

</div>
<p>如果验证 <code>has_one</code> 或 <code>has_many</code> 关联的对象是否为空，会在关联的对象上调用 <code>present?</code> 和 <code>marked_for_destruction?</code> 方法。</p>

<p>因为 <code>false.present?</code> 的返回值是 <code>false</code>，所以如果要验证布尔值字段是否为空要使用 <code>validates :field_name, exclusion: { in: [true, false] }</code>。</p>

<p>默认的错误消息是“must be blank”。</p>

<h3 id="uniqueness"><code>uniqueness</code></h3>

<p>这个帮助方法会在保存对象之前验证属性值是否是唯一的。该方法不会在数据库中创建唯一性约束，所以有可能两个数据库连接创建的记录字段的值是相同的。为了避免出现这种问题，要在数据库的字段上建立唯一性索引。关于多字段所以的详细介绍，参阅 <a href="http://dev.mysql.com/doc/refman/5.6/en/multiple-column-indexes.html">MySQL 手册</a>。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<p>这个验证会在模型对应的数据表中执行一个 SQL 查询，检查现有的记录中该字段是否已经出现过相同的值。</p>

<p><code>:scope</code> 选线可以指定其他属性，用来约束唯一性验证：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Holiday</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="p">{</span> <span class="ss">scope: :year</span><span class="p">,</span>
    <span class="ss">message: </span><span class="s2">"should happen once per year"</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<p>还有个 <code>:case_sensitive</code> 选线，指定唯一性验证是否要区分大小写，默认只为 <code>true</code>。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="p">{</span> <span class="ss">case_sensitive: </span><span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
          <div class="box warning-box">
  <p>注意，有些数据库的设置是，查询时不区分大小写。</p>
</div>


<p>默认的错误消息是“has already been taken”。</p>

<h3 id="validates-with"><code>validates_with</code></h3>

<p>这个帮助方法把记录交给其他的类做验证。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">GoodnessValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">record</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="s2">"Evil"</span>
      <span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:base</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"This person is evil"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates_with</span> <span class="no">GoodnessValidator</span>
<span class="k">end</span>
</pre>

</div>
          <div class="box information-box">
  <p><code>record.errors[:base]</code> 中的错误针对整个对象，而不是特定的属性。</p>
</div>


<p><code>validates_with</code> 方法的参数是一个类，或一组类，用来做验证。<code>validates_with</code> 方法没有默认的错误消息。在做验证的类中要手动把错误添加到记录的错误集合中。</p>

<p>实现 <code>validate</code> 方法时，必须指定 <code>record</code> 参数，这是要做验证的记录。</p>

<p>和其他验证一样，<code>validates_with</code> 也可指定 <code>:if</code>、<code>:unless</code> 和 <code>:on</code> 选项。如果指定了其他选项，会包含在 <code>options</code> 中传递给做验证的类。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">GoodnessValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:fields</span><span class="o">]</span><span class="p">.</span><span class="nf">any?</span><span class="p">{</span><span class="o">|</span><span class="n">field</span><span class="o">|</span> <span class="n">record</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Evil"</span> <span class="p">}</span>
      <span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:base</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"This person is evil"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates_with</span> <span class="no">GoodnessValidator</span><span class="p">,</span> <span class="ss">fields: </span><span class="o">[</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="o">]</span>
<span class="k">end</span>
</pre>

</div>
<p>注意，做验证的类在整个程序的生命周期内只会初始化一次，而不是每次验证时都初始化，所以使用实例变量时要特别小心。</p>

<p>如果做验证的类很复杂，必须要用实例变量，可以用纯粹的 Ruby 对象代替：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validate</span> <span class="k">do</span> <span class="o">|</span><span class="n">person</span><span class="o">|</span>
    <span class="no">GoodnessValidator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">person</span><span class="p">).</span><span class="nf">validate</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">GoodnessValidator</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
    <span class="vi">@person</span> <span class="o">=</span> <span class="n">person</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">validate</span>
    <span class="k">if</span> <span class="n">some_complex_condition_involving_ivars_and_private_methods?</span>
      <span class="vi">@person</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:base</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"This person is evil"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</pre>

</div>
<h3 id="validates-each"><code>validates_each</code></h3>

<p>这个帮助方法会把属性值传入代码库做验证，没有预先定义验证的方式，你应该在代码库中定义验证方式。要验证的每个属性都会传入块中做验证。在下面的例子中，我们确保名和姓都不能以小写字母开头：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates_each</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:surname</span> <span class="k">do</span> <span class="o">|</span><span class="n">record</span><span class="p">,</span> <span class="kp">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="kp">attr</span><span class="p">,</span> <span class="s1">'must start with upper case'</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="o">=~</span> <span class="sr">/\A[a-z]/</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>代码块的参数是记录，属性名和属性值。在代码块中可以做任何检查，确保数据合法。如果验证失败，要向模型添加一个错误消息，把数据标记为不合法。</p>

<h2 id="common-validation-options">常用的验证选项</h2>

<p>常用的验证选项包括：</p>

<h3 id="allow-nil"><code>:allow_nil</code></h3>

<p>指定 <code>:allow_nil</code> 选项后，如果要验证的值为 <code>nil</code> 就会跳过验证。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Coffee</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">inclusion: </span><span class="p">{</span> <span class="k">in</span><span class="p">:</span> <span class="sx">%w(small medium large)</span><span class="p">,</span>
    <span class="ss">message: </span><span class="s2">"%{value} is not a valid size"</span> <span class="p">},</span> <span class="ss">allow_nil: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<h3 id="allow-blank"><code>:allow_blank</code></h3>

<p><code>:allow_blank</code> 选项和 <code>:allow_nil</code> 选项类似。如果要验证的值为空（调用 <code>blank?</code> 方法，例如 <code>nil</code> 或空字符串），就会跳过验证。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Topic</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">is: </span><span class="mi">5</span> <span class="p">},</span> <span class="ss">allow_blank: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="no">Topic</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s2">""</span><span class="p">).</span><span class="nf">valid?</span>  <span class="c1"># =&gt; true</span>
<span class="no">Topic</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="kp">nil</span><span class="p">).</span><span class="nf">valid?</span> <span class="c1"># =&gt; true</span>
</pre>

</div>
<h3 id="message"><code>:message</code></h3>

<p>前面已经介绍过，如果验证失败，会把 <code>:message</code> 选项指定的字符串添加到 <code>errors</code> 集合中。如果没指定这个选项，Active Record 会使用各种验证帮助方法的默认错误消息。</p>

<h3 id="on"><code>:on</code></h3>

<p><code>:on</code> 选项指定什么时候做验证。所有内建的验证帮助方法默认都在保存时（新建记录或更新记录）做验证。如果想修改，可以使用 <code>on: :create</code>，指定只在创建记录时做验证；或者使用 <code>on: :update</code>，指定只在更新记录时做验证。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># it will be possible to update email with a duplicated value</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">on: :create</span>

  <span class="c1"># it will be possible to create the record with a non-numerical age</span>
  <span class="n">validates</span> <span class="ss">:age</span><span class="p">,</span> <span class="ss">numericality: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">on: :update</span>

  <span class="c1"># the default (validates on both create and update)</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<h2 id="strict-validations">严格验证</h2>

<p>数据验证还可以使用严格模式，失败后会抛出 <code>ActiveModel::StrictValidationFailed</code> 异常。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="p">{</span> <span class="ss">strict: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">valid?</span>  <span class="c1"># =&gt; ActiveModel::StrictValidationFailed: Name can't be blank</span>
</pre>

</div>
<p>通过 <code>:strict</code> 选项，还可以指定抛出什么异常：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:token</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">strict: </span><span class="no">TokenGenerationException</span>
<span class="k">end</span>

<span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">valid?</span>  <span class="c1"># =&gt; TokenGenerationException: Token can't be blank</span>
</pre>

</div>
<h2 id="conditional-validation">条件验证</h2>

<p>有时只有满足特定条件时做验证才说得通。条件可通过 <code>:if</code> 和 <code>:unless</code> 选项指定，这两个选项的值可以是 Symbol、字符串、<code>Proc</code> 或数组。<code>:if</code> 选项指定何时做验证。如果要指定何时不做验证，可以使用 <code>:unless</code> 选项。</p>

<h3 id="using-a-symbol-with-if-and-unless">指定 Symbol</h3>

<p><code>:if</code> 和 <code>:unless</code> 选项的值为 Symbol 时，表示要在验证之前执行对应的方法。这是最常用的设置方法。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:card_number</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="ss">:paid_with_card?</span>

  <span class="k">def</span> <span class="nf">paid_with_card?</span>
    <span class="n">payment_type</span> <span class="o">==</span> <span class="s2">"card"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<h3 id="using-a-string-with-if-and-unless">指定字符串</h3>

<p><code>:if</code> 和 <code>:unless</code> 选项的值还可以是字符串，但必须是 Ruby 代码，传入 <code>eval</code> 方法中执行。当字符串表示的条件非常短时才应该使用这种形式。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:surname</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="s2">"name.nil?"</span>
<span class="k">end</span>
</pre>

</div>
<h3 id="using-a-proc-with-if-and-unless">指定 Proc</h3>

<p><code>:if</code> and <code>:unless</code> 选项的值还可以是 Proc。使用 Proc 对象可以在行间编写条件，不用定义额外的方法。这种形式最适合用在一行代码能表示的条件上。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">confirmation: </span><span class="kp">true</span><span class="p">,</span>
    <span class="k">unless</span><span class="p">:</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="p">.</span><span class="nf">password</span><span class="p">.</span><span class="nf">blank?</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<h3 id="grouping-conditional-validations">条件组合</h3>

<p>有时同一个条件会用在多个验证上，这时可以使用 <code>with_options</code> 方法：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">with_options</span> <span class="k">if</span><span class="p">:</span> <span class="ss">:is_admin?</span> <span class="k">do</span> <span class="o">|</span><span class="n">admin</span><span class="o">|</span>
    <span class="n">admin</span><span class="p">.</span><span class="nf">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">minimum: </span><span class="mi">10</span> <span class="p">}</span>
    <span class="n">admin</span><span class="p">.</span><span class="nf">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p><code>with_options</code> 代码块中的所有验证都会使用 <code>if: :is_admin?</code> 这个条件。</p>

<h3 id="combining-validation-conditions">联合条件</h3>

<p>另一方面，如果是否做某个验证要满足多个条件时，可以使用数组。而且，都一个验证可以同时指定 <code>:if</code> 和 <code>:unless</code> 选项。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Computer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:mouse</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span>
                    <span class="k">if</span><span class="p">:</span> <span class="o">[</span><span class="s2">"market.retail?"</span><span class="p">,</span> <span class="ss">:desktop?</span><span class="o">]</span>
                    <span class="k">unless</span><span class="p">:</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">trackpad</span><span class="p">.</span><span class="nf">present?</span> <span class="p">}</span>
<span class="k">end</span>
</pre>

</div>
<p>只有当 <code>:if</code> 选项的所有条件都返回 <code>true</code>，且 <code>:unless</code> 选项中的条件返回 <code>false</code> 时才会做验证。</p>

<h2 id="performing-custom-validations">自定义验证方式</h2>

<p>如果内建的数据验证帮助方法无法满足需求时，可以选择自己定义验证使用的类或方法。</p>

<h3 id="custom-validators">自定义验证使用的类</h3>

<p>自定义的验证类继承自 <code>ActiveModel::Validator</code>，必须实现 <code>validate</code> 方法，传入的参数是要验证的记录，然后验证这个记录是否合法。自定义的验证类通过 <code>validates_with</code> 方法调用。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">MyValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">record</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">starts_with?</span> <span class="s1">'X'</span>
      <span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="s1">'Need a name starting with X please!'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span>
  <span class="n">validates_with</span> <span class="no">MyValidator</span>
<span class="k">end</span>
</pre>

</div>
<p>在自定义的验证类中验证单个属性，最简单的方法是集成 <code>ActiveModel::EachValidator</code> 类。此时，自定义的验证类中要实现 <code>validate_each</code> 方法。这个方法接受三个参数：记录，属性名和属性值。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">EmailValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">EachValidator</span>
  <span class="k">def</span> <span class="nf">validate_each</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">value</span> <span class="o">=~</span> <span class="sr">/\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i</span>
      <span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="n">attribute</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span> <span class="o">||</span> <span class="s2">"is not an email"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">email: </span><span class="kp">true</span>
<span class="k">end</span>
</pre>

</div>
<p>如上面的代码所示，可以同时使用内建的验证方法和自定义的验证类。</p>

<h3 id="custom-methods">自定义验证使用的方法</h3>

<p>还可以自定义方法验证模型的状态，如果验证失败，向 <code>erros</code> 集合添加错误消息。然后还要使用类方法 <code>validate</code> 注册这些方法，传入自定义验证方法名的 Symbol 形式。</p>

<p>类方法可以接受多个 Symbol，自定义的验证方法会按照注册的顺序执行。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Invoice</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validate</span> <span class="ss">:expiration_date_cannot_be_in_the_past</span><span class="p">,</span>
    <span class="ss">:discount_cannot_be_greater_than_total_value</span>

  <span class="k">def</span> <span class="nf">expiration_date_cannot_be_in_the_past</span>
    <span class="k">if</span> <span class="n">expiration_date</span><span class="p">.</span><span class="nf">present?</span> <span class="o">&amp;&amp;</span> <span class="n">expiration_date</span> <span class="o">&lt;</span> <span class="no">Date</span><span class="p">.</span><span class="nf">today</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:expiration_date</span><span class="p">,</span> <span class="s2">"can't be in the past"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">discount_cannot_be_greater_than_total_value</span>
    <span class="k">if</span> <span class="n">discount</span> <span class="o">&gt;</span> <span class="n">total_value</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:discount</span><span class="p">,</span> <span class="s2">"can't be greater than total value"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>默认情况下，每次调用 <code>valid?</code> 方法时都会执行自定义的验证方法。使用 <code>validate</code> 方法注册自定义验证方法时可以设置 <code>:on</code> 选项，执行什么时候运行。<code>:on</code> 的可选值为 <code>:create</code> 和 <code>:update</code>。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Invoice</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validate</span> <span class="ss">:active_customer</span><span class="p">,</span> <span class="ss">on: :create</span>

  <span class="k">def</span> <span class="nf">active_customer</span>
    <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:customer_id</span><span class="p">,</span> <span class="s2">"is not active"</span><span class="p">)</span> <span class="k">unless</span> <span class="n">customer</span><span class="p">.</span><span class="nf">active?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<h2 id="working-with-validation-errors">处理验证错误</h2>

<p>除了前面介绍的 <code>valid?</code> 和 <code>invalid?</code> 方法之外，Rails 还提供了很多方法用来处理 <code>errors</code> 集合，以及查询对象的合法性。</p>

<p>下面介绍其中一些常用的方法。所有可用的方法请查阅 <code>ActiveModel::Errors</code> 的文档。</p>

<h3 id="working-with-validation-errors-errors"><code>errors</code></h3>

<p><code>ActiveModel::Errors</code> 的实例包含所有的错误。其键是每个属性的名字，值是一个数组，包含错误消息字符串。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">minimum: </span><span class="mi">3</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="n">person</span><span class="p">.</span><span class="nf">valid?</span> <span class="c1"># =&gt; false</span>
<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">messages</span>
 <span class="c1"># =&gt; {:name=&gt;["can't be blank", "is too short (minimum is 3 characters)"]}</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"John Doe"</span><span class="p">)</span>
<span class="n">person</span><span class="p">.</span><span class="nf">valid?</span> <span class="c1"># =&gt; true</span>
<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">messages</span> <span class="c1"># =&gt; {}</span>
</pre>

</div>
<h3 id="errors"><code>errors[]</code></h3>

<p><code>errors[]</code> 用来获取某个属性上的错误消息，返回结果是一个由该属性所有错误消息字符串组成的数组，每个字符串表示一个错误消息。如果字段上没有错误，则返回空数组。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">minimum: </span><span class="mi">3</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"John Doe"</span><span class="p">)</span>
<span class="n">person</span><span class="p">.</span><span class="nf">valid?</span> <span class="c1"># =&gt; true</span>
<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="c1"># =&gt; []</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"JD"</span><span class="p">)</span>
<span class="n">person</span><span class="p">.</span><span class="nf">valid?</span> <span class="c1"># =&gt; false</span>
<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="c1"># =&gt; ["is too short (minimum is 3 characters)"]</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="n">person</span><span class="p">.</span><span class="nf">valid?</span> <span class="c1"># =&gt; false</span>
<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
 <span class="c1"># =&gt; ["can't be blank", "is too short (minimum is 3 characters)"]</span>
</pre>

</div>
<h3 id="errors-add"><code>errors.add</code></h3>

<p><code>add</code> 方法可以手动添加某属性的错误消息。使用 <code>errors.full_messages</code> 或 <code>errors.to_a</code> 方法会以最终显示给用户的形式显示错误消息。这些错误消息的前面都会加上字段名的复数形式。<code>add</code> 方法接受两个参数：错误消息要添加到的字段名和错误消息本身。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">a_method_used_for_validation_purposes</span>
    <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">"cannot contain the characters !@#%*()_-+="</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"!@#"</span><span class="p">)</span>

<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
 <span class="c1"># =&gt; ["cannot contain the characters !@#%*()_-+="]</span>

<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
 <span class="c1"># =&gt; ["Name cannot contain the characters !@#%*()_-+="]</span>
</pre>

</div>
<p>还有一种方法可以实现同样地效果，使用 <code>[]=</code> 设置方法：</p>

<div class="codeblock ruby"><pre class="highlight">  <span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="k">def</span> <span class="nf">a_method_used_for_validation_purposes</span>
      <span class="n">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"cannot contain the characters !@#%*()_-+="</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"!@#"</span><span class="p">)</span>

  <span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
   <span class="c1"># =&gt; ["cannot contain the characters !@#%*()_-+="]</span>

  <span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">to_a</span>
   <span class="c1"># =&gt; ["Name cannot contain the characters !@#%*()_-+="]</span>
</pre>

</div>
<h3 id="errors-base"><code>errors[:base]</code></h3>

<p>错误消息可以添加到整个对象上，而不是针对某个属性。如果不想管是哪个属性导致对象不合法，指向把对象标记为不合法状态，就可以使用这个方法。<code>errors[:base]</code> 是个数字，可以添加字符串作为错误消息。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">a_method_used_for_validation_purposes</span>
    <span class="n">errors</span><span class="o">[</span><span class="ss">:base</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"This person is invalid because ..."</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<h3 id="errors-clear"><code>errors.clear</code></h3>

<p>如果想清除 <code>errors</code> 集合中的所有错误消息，可以使用 <code>clear</code> 方法。当然了，在不合法的对象上调用 <code>errors.clear</code> 方法后，这个对象还是不合法的，虽然 <code>errors</code> 集合为空了，但下次调用 <code>valid?</code> 方法，或调用其他把对象存入数据库的方法时， 会再次进行验证。如果任何一个验证失败了，<code>errors</code> 集合中就再次出现值了。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">minimum: </span><span class="mi">3</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="n">person</span><span class="p">.</span><span class="nf">valid?</span> <span class="c1"># =&gt; false</span>
<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
 <span class="c1"># =&gt; ["can't be blank", "is too short (minimum is 3 characters)"]</span>

<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">clear</span>
<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">empty?</span> <span class="c1"># =&gt; true</span>

<span class="nb">p</span><span class="p">.</span><span class="nf">save</span> <span class="c1"># =&gt; false</span>

<span class="nb">p</span><span class="p">.</span><span class="nf">errors</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
<span class="c1"># =&gt; ["can't be blank", "is too short (minimum is 3 characters)"]</span>
</pre>

</div>
<h3 id="errors-size"><code>errors.size</code></h3>

<p><code>size</code> 方法返回对象上错误消息的总数。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">minimum: </span><span class="mi">3</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="n">person</span><span class="p">.</span><span class="nf">valid?</span> <span class="c1"># =&gt; false</span>
<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">size</span> <span class="c1"># =&gt; 2</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Andrea"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"andrea@example.com"</span><span class="p">)</span>
<span class="n">person</span><span class="p">.</span><span class="nf">valid?</span> <span class="c1"># =&gt; true</span>
<span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">size</span> <span class="c1"># =&gt; 0</span>
</pre>

</div>
<h2 id="displaying-validation-errors-in-views">在视图中显示验证错误</h2>

<p>在模型中加入数据验证后，如果在表单中创建模型，出错时，你或许想把错误消息显示出来。</p>

<p>因为每个程序显示错误消息的方式不同，所以 Rails 没有直接提供用来显示错误消息的视图帮助方法。不过，Rails 提供了这么多方法用来处理验证，自己编写一个也不难。使用脚手架时，Rails 会在生成的 <code>_form.html.erb</code> 中加入一些 ERB 代码，显示模型错误消息的完整列表。</p>

<p>假设有个模型对象存储在实例变量 <code>@post</code> 中，视图的代码可以这么写：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="o">&lt;</span><span class="sx">% if </span><span class="vi">@post</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">any?</span> <span class="sx">%&gt;
  &lt;div id="error_explanation"&gt;</span>
    <span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;&lt;</span><span class="sx">%= pluralize(@post.errors.count, "error") %&gt; prohibited this post from being saved:&lt;/h2&gt;

    &lt;ul&gt;
    &lt;% @post.errors.full_messages.each do |msg| %&gt;
      &lt;li&gt;&lt;%=</span> <span class="n">msg</span> <span class="sx">%&gt;&lt;/li&gt;</span>
    <span class="o">&lt;</span><span class="sx">% end %&gt;
    &lt;/ul&gt;</span>
  <span class="o">&lt;</span><span class="sr">/div&gt;
&lt;% end %&gt;
</span></pre>

</div>
<p>而且，如果使用 Rails 的表单帮助方法生成表单，如果某个表单字段验证失败，会把字段包含在一个 <code>&lt;div&gt;</code> 中：</p>

<div class="codeblock text"><pre class="highlight">&lt;div class="field_with_errors"&gt;
 &lt;input id="post_title" name="post[title]" size="30" type="text" value=""&gt;
&lt;/div&gt;
</pre>

</div>
<p>然后可以根据需求为这个 <code>div</code> 添加样式。脚手架默认添加的 CSS 如下：</p>

<div class="codeblock text"><pre class="highlight">.field_with_errors {
  padding: 2px;
  background-color: red;
  display: table;
}
</pre>

</div>
<p>所有出错的表单字段都会放入一个内边距为 2像素的红色框内。</p>

                    </article>
                    <div class="section-nav clearfix">
  <div class="pull-left">
    
      <a href="http://docs-china.com/rails/migrations.html" class="prev">
        &laquo;前一篇
      </a>
    
  </div>
  <div class="pull-right">
    
      <a href="http://docs-china.com/rails/active_record_callbacks.html" class="next">
        后一篇&raquo;
      </a>
    
  </div>
</div>

                </main>
                <div class="sidebar col-sm-3 col-md-3 hidden-xs">
                    <aside class="menu">
    
    <h4>起跑</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/getting_started.html">Rails 入门</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>模型</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_basics.html">Active Record 基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/migrations.html">Active Record 数据库迁移</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class="current"><a href="http://docs-china.com/rails/active_record_validations.html">Active Record 数据验证</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_callbacks.html">Active Record Callbacks</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/association_basics.html">Active Record 关联</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_querying.html">Active Record 查询</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>视图</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/action_view_overview.html">Action View 基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/layouts_and_rendering.html">Layouts and Rendering in Rails</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/form_helpers.html">表单帮助方法</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>控制器</h4>
    

<ul>

  

  
    
  

  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/action_controller_overview.html">Action Controller 简介</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/routing.html">Rails 路由全解</a></li>
    
  
    
  
    
  
    
  


</ul>

    
    <h4>深入</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_support_core_extensions.html">Active Support 核心扩展</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/i18n.html">Rails 国际化 API</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/action_mailer_basics.html">Action Mailer 基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/testing.html">Rails 程序测试指南</a></li>
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/security.html">Ruby on Rails 安全指南</a></li>
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/debugging_rails_applications.html">Rails 程序调试</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/configuring.html">Rails 程序设置</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/command_line.html">Rails 命令行</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/caching_with_rails.html">Caching with Rails An overview</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/asset_pipeline.html">Asset Pipeline</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</a></li>
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/engines.html">Getting Started with Engines</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/initialization.html">Rails 初始化过程</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>扩展</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/plugins.html">Rails 插件开发基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/rails_on_rack.html">Rails on Rack</a></li>
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/generators.html">Creating and Customizing Rails Generators & Templates</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
</aside>


                </div>
            </div>
        </div>
    </div>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <div>
                <ul class="social">
                    <li class="github">
                        <a href="https://github.com/docs-china/rails/" title="在 GitHub 上关注我们">Github</a>
                    </li>
                    <li class="weibo">
                        <a href="http://weibo.com/docschina" title="关注我们的微博">@DocsChina</a>
                    </li>
                </ul>
            </div>

            <p>本文档授权协议：<a href="http://creativecommons.org/licenses/by-sa/4.0/deed.zh" title="CC BY-SA 4.0">CC BY-SA 4.0</a></p>
        </div>
    </footer>
</body>
</html>
