<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Active Record 数据库迁移 - Rails 指南</title>
    <meta name="viewport" content="width=device-width" />
    <script src="http://docs-china.com/rails/scripts/docs.js"></script>
    <link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/3.1.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="http://docs-china.com/rails/scripts/docs.css" />
</head>
<body>
    <a class="sr-only" href="#content">跳到正文</a>

    <nav class="navbar navbar-static-top docs-nav" id="top">
        <div class="container">
            <div class="navbar-header">
                <a href="http://docs-china.com" class="navbar-brand" title="回到首页">&larr; Docs China</a>
            </div>
        </div>
    </nav>

    <header class="header" role="banner">
        <div class="container">
            <h1 class="logo"><a href="http://docs-china.com/rails/" title="Rails 指南">Rails 指南</a></h1>
            
            <iframe src="http://ghbtns.com/github-btn.html?user=docs-china&repo=&type=fork&count=false"
  allowtransparency="true" frameborder="0" scrolling="0" width="62" height="20"></iframe>
            
        </div>
    </header>

    <div id="content" class="content" role="main">
        <div class="container">
            <div class="row">
                <main class="main col-sm-9 col-md-9">
                    <article class="entry">
                        <h1>Active Record 数据库迁移</h1>
                        <p>迁移是 Active Record 提供的一个功能，按照时间顺序管理数据库模式。使用迁移，无需编写 SQL，使用简单的 Ruby DSL 就能修改数据表。</p>

<p>读完本文，你将学到：</p>

<ul>
  <li>生成迁移文件的生成器；</li>
  <li>Active Record 提供用来修改数据库的方法；</li>
  <li>管理迁移和数据库模式的 Rake 任务；</li>
  <li>迁移和 <code>schema.rb</code> 文件的关系；</li>
</ul>

<hr />

<h2 id="migration-overview">迁移简介</h2>

<p>迁移使用一种统一、简单的方式，按照时间顺序修改数据库的模式。迁移使用 Ruby DSL 编写，因此不用手动编写 SQL 语句，对数据库的操作和所用的数据库种类无关。</p>

<p>你可以把每个迁移看做数据库的一个修订版本。数据库中一开始什么也没有，各个迁移会添加或删除数据表、字段或记录。Active Record 知道如何按照时间线更新数据库，不管数据库现在的模式如何，都能更新到最新结构。同时，Active Record 还会更新 <code>db/schema.rb</code> 文件，匹配最新的数据库结构。</p>

<p>下面是一个迁移示例：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>这个迁移创建了一个名为 <code>products</code> 的表，然后在表中创建字符串字段 <code>name</code> 和文本字段 <code>description</code>。名为 <code>id</code> 的主键字段会被自动创建。<code>id</code> 字段是所有 Active Record 模型的默认主键。<code>timestamps</code> 方法创建两个字段：<code>created_at</code> 和 <code>updated_at</code>。如果数据表中有这两个字段，Active Record 会负责操作。</p>

<p>注意，对数据库的改动按照时间向前 推移。运行迁移之前，数据表还不存在。运行迁移后，才会创建数据表。Active Record 知道如何撤销迁移，如果回滚这次迁移，数据表会被删除。</p>

<p>在支持事物的数据库中，对模式的改动会在一个事物中执行。如果数据库不支持事物，迁移失败时，成功执行的操作将无法回滚。如要回滚，必须手动改回来。</p>

          <div class="box information-box">
  <p>某些查询无法在事物中运行。如果适配器支持 DDL 事物，可以在某个迁移中调用 <code>disable_ddl_transaction!</code> 方法禁用。</p>
</div>


<p>如果想在迁移中执行 Active Record 不知如何撤销的操作，可以使用 <code>reversible</code> 方法：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">ChangeProductsPrice</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
      <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">dir</span><span class="p">.</span><span class="nf">up</span>   <span class="p">{</span> <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:string</span> <span class="p">}</span>
        <span class="n">dir</span><span class="p">.</span><span class="nf">down</span> <span class="p">{</span> <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:integer</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>或者不用 <code>change</code> 方法，分别使用 <code>up</code> 和 <code>down</code> 方法：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">ChangeProductsPrice</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">change</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:integer</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<h2 id="creating-a-migration">创建迁移</h2>

<h3 id="creating-a-standalone-migration">单独创建迁移</h3>

<p>迁移文件存储在 <code>db/migrate</code> 文件夹中，每个迁移保存在一个文件中。文件名采用 <code>YYYYMMDDHHMMSS_create_products.rb</code> 形式，即一个 UTC 时间戳后加以下划线分隔的迁移名。迁移的类名（驼峰式）要和文件名时间戳后面的部分匹配。例如，在 <code>20080906120000_create_products.rb</code> 文件中要定义 <code>CreateProducts</code> 类；在 <code>20080906120001_add_details_to_products.rb</code> 文件中要定义 <code>AddDetailsToProducts</code> 类。文件名中的时间戳决定要运行哪个迁移，以及按照什么顺序运行。从其他程序中复制迁移，或者自己生成迁移时，要注意运行的顺序。</p>

<p>自己计算时间戳不是件简单的事，所以 Active Record 提供了一个生成器：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rails generate migration AddPartNumberToProducts
</pre>

</div>
<p>这个命令生成一个空的迁移，但名字已经起好了：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">AddPartNumberToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>如果迁移的名字是“AddXXXToYYY”或者“RemoveXXXFromYYY”这种格式，而且后面跟着一个字段名和类型列表，那么迁移中会生成合适的 <code>add_column</code> 或 <code>remove_column</code> 语句。</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rails generate migration AddPartNumberToProducts part_number:string
</pre>

</div>
<p>这个命令生成的迁移如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">AddPartNumberToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>如果想为新建的字段创建添加索引，可以这么做：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rails generate migration AddPartNumberToProducts part_number:string:index
</pre>

</div>
<p>这个命令生成的迁移如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">AddPartNumberToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>类似地，还可以生成删除字段的迁移：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rails generate migration RemovePartNumberFromProducts part_number:string
</pre>

</div>
<p>这个命令生成的迁移如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">RemovePartNumberFromProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">remove_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>迁移生成器不单只能创建一个字段，例如：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rails generate migration AddDetailsToProducts part_number:string price:decimal
</pre>

</div>
<p>生成的迁移如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">AddDetailsToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:decimal</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>如果迁移名是“CreateXXX”形式，后面跟着一串字段名和类型声明，迁移就会创建名为“XXX”的表，以及相应的字段。例如：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rails generate migration CreateProducts name:string part_number:string
</pre>

</div>
<p>生成的迁移如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>生成器生成的只是一些基础代码，你可以根据需要修改 <code>db/migrate/YYYYMMDDHHMMSS_add_details_to_products.rb</code> 文件，增删代码。</p>

<p>在生成器中还可把字段类型设为 <code>references</code>（还可使用 <code>belongs_to</code>）。例如：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rails generate migration AddUserRefToProducts user:references
</pre>

</div>
<p>生成的迁移如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">AddUserRefToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>这个迁移会创建 <code>user_id</code> 字段，并建立索引。</p>

<p>如果迁移名中包含 <code>JoinTable</code>，生成器还会创建联合数据表：</p>

<div class="codeblock bash"><pre class="highlight">rails g migration CreateJoinTableCustomerProduct customer product
</pre>

</div>
<p>生成的迁移如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">CreateJoinTableCustomerProduct</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:customers</span><span class="p">,</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="c1"># t.index [:customer_id, :product_id]</span>
      <span class="c1"># t.index [:product_id, :customer_id]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<h3 id="model-generators">模型生成器</h3>

<p>模型生成器和脚手架生成器会生成合适的迁移，创建模型。迁移中会包含创建所需数据表的代码。如果在生成器中指定了字段，还会生成创建字段的代码。例如，运行下面的命令：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rails generate model Product name:string description:text
</pre>

</div>
<p>会生成如下的迁移：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>字段的名字和类型数量不限。</p>

<h3 id="supported-type-modifiers">支持的类型修饰符</h3>

<p>在字段类型后面，可以在花括号中添加选项。可用的修饰符如下：</p>

<ul>
  <li><code>limit</code>：设置 <code>string/text/binary/integer</code> 类型字段的最大值；</li>
  <li><code>precision</code>：设置 <code>decimal</code> 类型字段的精度，即数字的位数；</li>
  <li><code>scale</code>：设置 <code>decimal</code> 类型字段小数点后的数字位数；</li>
  <li><code>polymorphic</code>：为 <code>belongs_to</code> 关联添加 <code>type</code> 字段；</li>
  <li><code>null</code>：是否允许该字段的值为 <code>NULL</code>；</li>
</ul>

<p>例如，执行下面的命令：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rails generate migration AddDetailsToProducts <span class="s1">'price:decimal{5,2}'</span> supplier:references<span class="o">{</span>polymorphic<span class="o">}</span>
</pre>

</div>
<p>生成的迁移如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">AddDetailsToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:decimal</span><span class="p">,</span> <span class="ss">precision: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">scale: </span><span class="mi">2</span>
    <span class="n">add_reference</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<h2 id="writing-a-migration">编写迁移</h2>

<p>使用前面介绍的生成器生成迁移后，就可以开始写代码了。</p>

<h3 id="creating-a-table">创建数据表</h3>

<p><code>create_table</code> 方法最常用，大多数时候都会由模型或脚手架生成器生成。典型的用例如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
<span class="k">end</span>
</pre>

</div>
<p>这个迁移会创建 <code>products</code> 数据表，在数据表中创建 <code>name</code> 字段（后面会介绍，还会自动创建 <code>id</code> 字段）。</p>

<p>默认情况下，<code>create_table</code> 方法会创建名为 <code>id</code> 的主键。通过 <code>:primary_key</code> 选项可以修改主键名（修改后别忘了修改相应的模型）。如果不想生成主键，可以传入 <code>id: false</code> 选项。如果设置数据库的选项，可以在 <code>:options</code> 选择中使用 SQL。例如：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="n">create_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">options: </span><span class="s2">"ENGINE=BLACKHOLE"</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
<span class="k">end</span>
</pre>

</div>
<p>这样设置之后，会在创建数据表的 SQL 语句后面加上 <code>ENGINE=BLACKHOLE</code>。（MySQL 默认的选项是 <code>ENGINE=InnoDB</code>）</p>

<h3 id="creating-a-join-table">创建联合数据表</h3>

<p><code>create_join_table</code> 方法用来创建 HABTM 联合数据表。典型的用例如下：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span>
</pre>

</div>
<p>这段代码会创建一个名为 <code>categories_products</code> 的数据表，包含两个字段：<code>category_id</code> 和 <code>product_id</code>。这两个字段的 <code>:null</code> 选项默认情况都是 <code>false</code>，不过可在 <code>:column_options</code> 选项中设置。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">column_options: </span><span class="p">{</span><span class="ss">null: </span><span class="kp">true</span><span class="p">}</span>
</pre>

</div>
<p>这段代码会把 <code>product_id</code> 和 <code>category_id</code> 字段的 <code>:null</code> 选项设为 <code>true</code>。</p>

<p>如果想修改数据表的名字，可以传入 <code>:table_name</code> 选项。例如：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">table_name: :categorization</span>
</pre>

</div>
<p>创建的数据表名为 <code>categorization</code>。</p>

<p><code>create_join_table</code> 还可接受代码库，用来创建索引（默认无索引）或其他字段。</p>

<div class="codeblock ruby"><pre class="highlight"><span class="n">create_join_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:categories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:product_id</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:category_id</span>
<span class="k">end</span>
</pre>

</div>
<h3 id="changing-tables">修改数据表</h3>

<p>有一个和 <code>create_table</code> 类似地方法，名为 <code>change_table</code>，用来修改现有的数据表。其用法和 <code>create_table</code> 类似，不过传入块的参数知道更多技巧。例如：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">remove</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:name</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_number</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">rename</span> <span class="ss">:upccode</span><span class="p">,</span> <span class="ss">:upc_code</span>
<span class="k">end</span>
</pre>

</div>
<p>这段代码删除了 <code>description</code> 和 <code>name</code> 字段，创建 <code>part_number</code> 字符串字段，并建立索引，最后重命名 <code>upccode</code> 字段。</p>

<h3 id="when-helpers-arent-enough">如果帮助方法不够用</h3>

<p>如果 Active Record 提供的帮助方法不够用，可以使用 <code>excute</code> 方法，执行任意的 SQL 语句：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="no">Product</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s1">'UPDATE `products` SET `price`=`free` WHERE 1'</span><span class="p">)</span>
</pre>

</div>
<p>各方法的详细用法请查阅 API 文档：</p>

<ul>
  <li><a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html"><code>ActiveRecord::ConnectionAdapters::SchemaStatements</code></a>：包含可在 <code>change</code>，<code>up</code> 和 <code>down</code> 中使用的方法；</li>
  <li><a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/TableDefinition.html"><code>ActiveRecord::ConnectionAdapters::TableDefinition</code></a>：包含可在 <code>create_table</code> 方法的块参数上调用的方法；</li>
  <li><a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html"><code>ActiveRecord::ConnectionAdapters::Table</code></a>：包含可在 <code>change_table</code> 方法的块参数上调用的方法；</li>
</ul>

<h3 id="using-the-change-method">使用 <code>change</code> 方法</h3>

<p><code>change</code> 是迁移中最常用的方法，大多数情况下都能完成指定的操作，而且 Active Record 知道如何撤这些操作。目前，在 <code>change</code> 方法中只能使用下面的方法：</p>

<ul>
  <li><code>add_column</code></li>
  <li><code>add_index</code></li>
  <li><code>add_reference</code></li>
  <li><code>add_timestamps</code></li>
  <li><code>create_table</code></li>
  <li><code>create_join_table</code></li>
  <li><code>drop_table</code>（必须提供代码块）</li>
  <li><code>drop_join_table</code>（必须提供代码块）</li>
  <li><code>remove_timestamps</code></li>
  <li><code>rename_column</code></li>
  <li><code>rename_index</code></li>
  <li><code>remove_reference</code></li>
  <li><code>rename_table</code></li>
</ul>

<p>只要在块中不使用 <code>change</code>、<code>change_default</code> 或 <code>remove</code> 方法，<code>change_table</code> 中的操作也是可逆的。</p>

<p>如果要使用任何其他方法，可以使用 <code>reversible</code> 方法，或者不定义 <code>change</code> 方法，而分别定义 <code>up</code> 和 <code>down</code> 方法。</p>

<h3 id="using-reversible">使用 <code>reversible</code> 方法</h3>

<p>Active Record 可能不知如何撤销复杂的迁移操作，这时可以使用 <code>reversible</code> 方法指定运行迁移和撤销迁移时怎么操作。例如：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">ExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:category</span>
    <span class="k">end</span>

    <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
      <span class="n">dir</span><span class="p">.</span><span class="nf">up</span> <span class="k">do</span>
        <span class="c1">#add a foreign key</span>
        <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
          ALTER TABLE products
            ADD CONSTRAINT fk_products_categories
            FOREIGN KEY (category_id)
            REFERENCES categories(id)
</span><span class="no">        SQL</span>
      <span class="k">end</span>
      <span class="n">dir</span><span class="p">.</span><span class="nf">down</span> <span class="k">do</span>
        <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
          ALTER TABLE products
            DROP FOREIGN KEY fk_products_categories
</span><span class="no">        SQL</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:home_page_url</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:email_address</span>
  <span class="k">end</span>
</pre>

</div>
<p>使用 <code>reversible</code> 方法还能确保操作按顺序执行。在上面的例子中，如果撤销迁移，<code>down</code> 代码块会在 <code>home_page_url</code> 字段删除后、<code>products</code> 数据表删除前运行。</p>

<p>有时，迁移的操作根本无法撤销，例如删除数据。这是，可以在 <code>down</code> 代码块中抛出 <code>ActiveRecord::IrreversibleMigration</code> 异常。如果有人尝试撤销迁移，会看到一个错误消息，告诉他无法撤销。</p>

<h3 id="using-the-up-down-methods">使用 <code>up</code> 和 <code>down</code> 方法</h3>

<p>在迁移中可以不用 <code>change</code> 方法，而用 <code>up</code> 和 <code>down</code> 方法。<code>up</code> 方法定义要对数据库模式做哪些操作，<code>down</code> 方法用来撤销这些操作。也就是说，如果执行 <code>up</code> 后立即执行 <code>down</code>，数据库的模式应该没有任何变化。例如，在 <code>up</code> 中创建了数据表，在 <code>down</code> 方法中就要将其删除。撤销时最好按照添加的相反顺序进行。前一节中的 <code>reversible</code> 用法示例代码可以改成：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">ExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:category</span>
    <span class="k">end</span>

    <span class="c1"># add a foreign key</span>
    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
      ALTER TABLE products
        ADD CONSTRAINT fk_products_categories
        FOREIGN KEY (category_id)
        REFERENCES categories(id)
</span><span class="no">    SQL</span>

    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:home_page_url</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:email_address</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email_address</span><span class="p">,</span> <span class="ss">:email</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:home_page_url</span>

    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
      ALTER TABLE products
        DROP FOREIGN KEY fk_products_categories
</span><span class="no">    SQL</span>

    <span class="n">drop_table</span> <span class="ss">:products</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>如果迁移不可撤销，应该在 <code>down</code> 方法中抛出 <code>ActiveRecord::IrreversibleMigration</code> 异常。如果有人尝试撤销迁移，会看到一个错误消息，告诉他无法撤销。</p>

<h3 id="reverting-previous-migrations">撤销之前的迁移</h3>

<p>Active Record 提供了撤销迁移的功能，通过 <code>revert</code> 方法实现：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="n">require_relative</span> <span class="s1">'2012121212_example_migration'</span>

<span class="k">class</span> <span class="nc">FixupExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">revert</span> <span class="no">ExampleMigration</span>

    <span class="n">create_table</span><span class="p">(</span><span class="ss">:apples</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:variety</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p><code>revert</code> 方法还可接受一个块，定义撤销操作。<code>revert</code> 方法可用来撤销以前迁移的部分操作。例如，<code>ExampleMigration</code> 已经执行，但后来觉得最好还是序列化产品列表。那么，可以编写下面的代码：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">SerializeProductListMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:categories</span><span class="p">,</span> <span class="ss">:product_list</span>

    <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
      <span class="n">dir</span><span class="p">.</span><span class="nf">up</span> <span class="k">do</span>
        <span class="c1"># transfer data from Products to Category#product_list</span>
      <span class="k">end</span>
      <span class="n">dir</span><span class="p">.</span><span class="nf">down</span> <span class="k">do</span>
        <span class="c1"># create Products from Category#product_list</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">revert</span> <span class="k">do</span>
      <span class="c1"># copy-pasted code from ExampleMigration</span>
      <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:category</span>
      <span class="k">end</span>

      <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
        <span class="n">dir</span><span class="p">.</span><span class="nf">up</span> <span class="k">do</span>
          <span class="c1">#add a foreign key</span>
          <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
            ALTER TABLE products
              ADD CONSTRAINT fk_products_categories
              FOREIGN KEY (category_id)
              REFERENCES categories(id)
</span><span class="no">          SQL</span>
        <span class="k">end</span>
        <span class="n">dir</span><span class="p">.</span><span class="nf">down</span> <span class="k">do</span>
          <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
            ALTER TABLE products
              DROP FOREIGN KEY fk_products_categories
</span><span class="no">          SQL</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1"># The rest of the migration was ok</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>上面这个迁移也可以不用 <code>revert</code> 方法，不过步骤就多了：调换 <code>create_table</code> 和 <code>reversible</code> 的顺序，把 <code>create_table</code> 换成 <code>drop_table</code>，还要对调 <code>up</code> 和 <code>down</code> 中的代码。这些操作都可交给 <code>revert</code> 方法完成。</p>

<h2 id="running-migrations">运行迁移</h2>

<p>Rails 提供了很多 Rake 任务，用来执行指定的迁移。</p>

<p>其中最常使用的是 <code>rake db:migrate</code>，执行还没执行的迁移中的 <code>change</code> 或 <code>up</code> 方法。如果没有未运行的迁移，直接退出。<code>rake db:migrate</code> 按照迁移文件名中时间戳顺序执行迁移。</p>

<p>注意，执行 <code>db:migrate</code> 时还会执行 <code>db:schema:dump</code>，更新 <code>db/schema.rb</code> 文件，匹配数据库的结构。</p>

<p>如果指定了版本，Active Record 会运行该版本之前的所有迁移。版本就是迁移文件名前的数字部分。例如，要运行 20080906120000 这个迁移，可以执行下面的命令：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rake db:migrate <span class="nv">VERSION</span><span class="o">=</span>20080906120000
</pre>

</div>
<p>如果 20080906120000 比当前的版本高，上面的命令就会执行所有 20080906120000 之前（包括 20080906120000）的迁移中的 <code>change</code> 或 <code>up</code> 方法，但不会运行 20080906120000 之后的迁移。如果回滚迁移，则会执行 20080906120000 之前（不包括 20080906120000）的迁移中的 <code>down</code> 方法。</p>

<h3 id="rolling-back">回滚</h3>

<p>还有一个常用的操作时回滚到之前的迁移。例如，迁移代码写错了，想纠正。我们无须查找迁移的版本号，直接执行下面的命令即可：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rake db:rollback
</pre>

</div>
<p>这个命令会回滚上一次迁移，撤销 <code>change</code> 方法中的操作，或者执行 <code>down</code> 方法。如果想撤销多个迁移，可以使用 <code>STEP</code> 参数：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rake db:rollback <span class="nv">STEP</span><span class="o">=</span>3
</pre>

</div>
<p>这个命令会撤销前三次迁移。</p>

<p><code>db:migrate:redo</code> 命令可以回滚上一次迁移，然后再次执行迁移。和 <code>db:rollback</code> 一样，如果想重做多次迁移，可以使用 <code>STEP</code> 参数。例如：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rake db:migrate:redo <span class="nv">STEP</span><span class="o">=</span>3
</pre>

</div>
<p>这些 Rake 任务的作用和 <code>db:migrate</code> 一样，只是用起来更方便，因为无需查找特定的迁移版本号。</p>

<h3 id="setup-the-database">搭建数据库</h3>

<p><code>rake db:setup</code> 任务会创建数据库，加载模式，并填充种子数据。</p>

<h3 id="resetting-the-database">重建数据库</h3>

<p><code>rake db:reset</code> 任务会删除数据库，然后重建，等价于 <code>rake db:drop db:setup</code>。</p>

          <div class="box information-box">
  <p>这个任务和执行所有迁移的作用不同。<code>rake db:reset</code> 使用的是 <code>schema.rb</code> 文件中的内容。如果迁移无法回滚，<code>rake db:reset</code> 起不了作用。详细介绍参见“<a href="#schema-dumping-and-you">导出模式</a>”一节。</p>
</div>


<h3 id="running-specific-migrations">运行指定的迁移</h3>

<p>如果想执行指定迁移，或者撤销指定迁移，可以使用 <code>db:migrate:up</code> 和 <code>db:migrate:down</code> 任务，指定相应的版本号，就会根据需求调用 <code>change</code>、<code>up</code> 或 <code>down</code> 方法。例如：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rake db:migrate:up <span class="nv">VERSION</span><span class="o">=</span>20080906120000
</pre>

</div>
<p>这个命令会执行 20080906120000 迁移中的 <code>change</code> 方法或 <code>up</code> 方法。<code>db:migrate:up</code> 首先会检测指定的迁移是否已经运行，如果 Active Record 任务已经执行，就不会做任何操作。</p>

<h3 id="running-migrations-in-different-environments">在不同的环境中运行迁移</h3>

<p>默认情况下，<code>rake db:migrate</code> 任务在 <code>development</code> 环境中执行。要在其他环境中运行迁移，执行命令时可以使用环境变量 <code>RAILS_ENV</code> 指定环境。例如，要在 <code>test</code> 环境中运行迁移，可以执行下面的命令：</p>

<div class="codeblock bash"><pre class="highlight"><span class="gp">$ </span>rake db:migrate <span class="nv">RAILS_ENV</span><span class="o">=</span><span class="nb">test</span>
</pre>

</div>
<h3 id="changing-the-output-of-running-migrations">修改运行迁移时的输出</h3>

<p>默认情况下，运行迁移时，会输出操作了哪些操作，以及花了多长时间。创建数据表并添加索引的迁移产生的输出如下：</p>

<div class="codeblock bash"><pre class="highlight"><span class="o">==</span>  CreateProducts: migrating <span class="o">=================================================</span>
-- create_table<span class="o">(</span>:products<span class="o">)</span>
   -&gt; 0.0028s
<span class="o">==</span>  CreateProducts: migrated <span class="o">(</span>0.0028s<span class="o">)</span> <span class="o">========================================</span>
</pre>

</div>
<p>在迁移中可以使用很多方法，控制输出：</p>

<div class="table-responsive"><table>
  <thead>
    <tr>
      <th>方法</th>
      <th>作用</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>suppress_messages</td>
      <td>接受一个代码块，禁止代码块中所有操作的输出</td>
    </tr>
    <tr>
      <td>say</td>
      <td>接受一个消息字符串作为参数，将其输出。第二个参数是布尔值，指定输出结果是否缩进</td>
    </tr>
    <tr>
      <td>say_with_time</td>
      <td>输出文本，以及执行代码块中操作所用时间。如果代码块的返回结果是整数，会当做操作的记录数量</td>
    </tr>
  </tbody>
</table>
</div>
<p>例如，下面这个迁移：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">suppress_messages</span> <span class="k">do</span>
      <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">say</span> <span class="s2">"Created a table"</span>

    <span class="n">suppress_messages</span> <span class="p">{</span><span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:name</span><span class="p">}</span>
    <span class="n">say</span> <span class="s2">"and an index!"</span><span class="p">,</span> <span class="kp">true</span>

    <span class="n">say_with_time</span> <span class="s1">'Waiting for a while'</span> <span class="k">do</span>
      <span class="nb">sleep</span> <span class="mi">10</span>
      <span class="mi">250</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>输出结果是：</p>

<div class="codeblock bash"><pre class="highlight"><span class="o">==</span>  CreateProducts: migrating <span class="o">=================================================</span>
-- Created a table
   -&gt; and an index!
-- Waiting <span class="k">for </span>a <span class="k">while</span>
   -&gt; 10.0013s
   -&gt; 250 rows
<span class="o">==</span>  CreateProducts: migrated <span class="o">(</span>10.0054s<span class="o">)</span> <span class="o">=======================================</span>
</pre>

</div>
<p>如果不想让 Active Record 输出任何结果，可以使用 <code>rake db:migrate VERBOSE=false</code>。</p>

<h2 id="changing-existing-migrations">修改现有的迁移</h2>

<p>有时编写的迁移中可能有错误，如果已经运行了迁移，不能直接编辑迁移文件再运行迁移。Rails 认为这个迁移已经运行，所以执行 <code>rake db:migrate</code> 任务时什么也不会做。这种情况必须先回滚迁移（例如，执行 <code>rake db:rollback</code> 任务），编辑迁移文件后再执行 <code>rake db:migrate</code> 任务执行改正后的版本。</p>

<p>一般来说，直接修改现有的迁移不是个好主意。这么做会为你以及你的同事带来额外的工作量，如果这个迁移已经在生产服务器上运行过，还可能带来不必要的麻烦。你应该编写一个新的迁移，做所需的改动。编辑新生成还未纳入版本控制的迁移（或者更宽泛地说，还没有出现在开发设备之外），相对来说是安全的。</p>

<p>在新迁移中撤销之前迁移中的全部操作或者部分操作可以使用 <code>revert</code> 方法。（参见前面的 <a href="#reverting-previous-migrations">撤销之前的迁移</a> 一节）</p>

<h2 id="schema-dumping-and-you">导出模式</h2>

<h3 id="what-are-schema-files-for">模式文件的作用</h3>

<p>迁移的作用并不是为数据库模式提供可信的参考源。<code>db/schema.rb</code> 或由 Active Record 生成的 SQL 文件才有这个作用。<code>db/schema.rb</code> 这些文件不可修改，其目的是表示数据库的当前结构。</p>

<p>部署新程序时，无需运行全部的迁移。直接加载数据库结构要简单快速得多。</p>

<p>例如，测试数据库是这样创建的：导出开发数据库的结构（存入文件 <code>db/schema.rb</code> 或 <code>db/structure.sql</code>），然后导入测试数据库。</p>

<p>模式文件还可以用来快速查看 Active Record 中有哪些属性。模型中没有属性信息，而且迁移会频繁修改属性，但是模式文件中有最终的结果。<a href="https://github.com/ctran/annotate_models">annotate_models</a> gem 会在模型文件的顶部加入注释，自动添加并更新模型的模式。</p>

<h3 id="types-of-schema-dumps">导出的模式文件类型</h3>

<p>导出模式有两种方法，由 <code>config/application.rb</code> 文件中的 <code>config.active_record.schema_format</code> 选项设置，可以是 <code>:sql</code> 或 <code>:ruby</code>。</p>

<p>如果设为 <code>:ruby</code>，导出的模式保存在 <code>db/schema.rb</code> 文件中。打开这个文件，你会发现内容很多，就像一个很大的迁移：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span><span class="p">(</span><span class="ss">version: </span><span class="mi">20080906171750</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">create_table</span> <span class="s2">"authors"</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"name"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span>
  <span class="k">end</span>

  <span class="n">create_table</span> <span class="s2">"products"</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"name"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="s2">"description"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"part_number"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>大多数情况下，文件的内容都是这样。这个文件使用 <code>create_table</code>、<code>add_index</code> 等方法审查数据库的结构。这个文件盒使用的数据库类型无关，可以导入任何一种 Active Record 支持的数据库。如果开发的程序需要兼容多种数据库，可以使用这个文件。</p>

<p>不过 <code>db/schema.rb</code> 也有缺点：无法执行数据库的某些操作，例如外键约束，触发器，存储过程。在迁移文件中可以执行 SQL 语句，但导出模式的程序无法从数据库中重建这些语句。如果你的程序用到了前面提到的数据库操作，可以把模式文件的格式设为 <code>:sql</code>。</p>

<p><code>:sql</code> 格式的文件不使用 Active Record 的模式导出程序，而使用数据库自带的导出工具（执行 <code>db:structure:dump</code> 任务），把数据库模式导入 <code>db/structure.sql</code> 文件。例如，PostgreSQL 使用 <code>pg_dump</code> 导出模式。如果使用 MySQL，<code>db/structure.sql</code> 文件中会出现多个 <code>SHOW CREATE TABLE</code> 用来创建数据表的语句。</p>

<p>加载模式时，只要执行其中的 SQL 语句即可。按预期，导入后会创建一个完整的数据库结构。使用 <code>:sql</code> 格式，就不能把模式导入其他类型的数据库中了。</p>

<h3 id="schema-dumps-and-source-control">模式导出和版本控制</h3>

<p>因为导出的模式文件时数据库模式的可信源，强烈推荐将其纳入版本控制。</p>

<h2 id="active-record-and-referential-integrity">Active Record 和引用完整性</h2>

<p>Active Record 在模型中，而不是数据库中设置关联。因此，需要在数据库中实现的功能，例如触发器、外键约束，不太常用。</p>

<p><code>validates :foreign_key, uniqueness: true</code> 这个验证是模型保证数据完整性的一种方法。在关联中设置 <code>:dependent</code> 选项，可以保证父对象删除后，子对象也会被删除。和任何一种程序层的操作一样，这些无法完全保证引用完整性，所以很多人还是会在数据库中使用外键约束。</p>

<p>Active Record 并没有为使用这些功能提供任何工具，不过 <code>execute</code> 方法可以执行任意的 SQL 语句。还可以使用 <a href="https://github.com/matthuhiggins/foreigner">foreigner</a> 等 gem，为 Active Record 添加外键支持（还能白外键导出到 <code>db/schema.rb</code> 文件）。</p>

<h2 id="migrations-and-seed-data">迁移和种子数据</h2>

<p>有些人使用迁移把数据存入数据库：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="k">class</span> <span class="nc">AddInitialProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
      <span class="no">Product</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Product #</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"A product."</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="no">Product</span><span class="p">.</span><span class="nf">delete_all</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>

</div>
<p>Rails 提供了“种子”功能，可以把初始化数据存入数据库。这个功能用起来很简单，在 <code>db/seeds.rb</code> 文件中写一些 Ruby 代码，然后执行 <code>rake db:seed</code> 命令即可：</p>

<div class="codeblock ruby"><pre class="highlight"><span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
  <span class="no">Product</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Product #</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"A product."</span><span class="p">)</span>
<span class="k">end</span>
</pre>

</div>
<p>填充新建程序的数据库，使用这种方法操作起来简洁得多。</p>

                    </article>
                    <div class="section-nav clearfix">
  <div class="pull-left">
    
      <a href="http://docs-china.com/rails/active_record_basics.html" class="prev">
        &laquo;前一篇
      </a>
    
  </div>
  <div class="pull-right">
    
      <a href="http://docs-china.com/rails/active_record_validations.html" class="next">
        后一篇&raquo;
      </a>
    
  </div>
</div>

                </main>
                <div class="sidebar col-sm-3 col-md-3 hidden-xs">
                    <aside class="menu">
    
    <h4>起跑</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/getting_started.html">Rails 入门</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>模型</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_basics.html">Active Record 基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class="current"><a href="http://docs-china.com/rails/migrations.html">Active Record 数据库迁移</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_validations.html">Active Record 数据验证</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_callbacks.html">Active Record Callbacks</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/association_basics.html">Active Record 关联</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_record_querying.html">Active Record 查询</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>视图</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/action_view_overview.html">Action View 基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/layouts_and_rendering.html">Layouts and Rendering in Rails</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/form_helpers.html">表单帮助方法</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>控制器</h4>
    

<ul>

  

  
    
  

  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/action_controller_overview.html">Action Controller 简介</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/routing.html">Rails 路由全解</a></li>
    
  
    
  
    
  
    
  


</ul>

    
    <h4>深入</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/active_support_core_extensions.html">Active Support 核心扩展</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/i18n.html">Rails 国际化 API</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/action_mailer_basics.html">Action Mailer 基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/testing.html">Rails 程序测试指南</a></li>
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/security.html">Ruby on Rails 安全指南</a></li>
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/debugging_rails_applications.html">Rails 程序调试</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/configuring.html">Rails 程序设置</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/command_line.html">Rails 命令行</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/caching_with_rails.html">Caching with Rails An overview</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/asset_pipeline.html">Asset Pipeline</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</a></li>
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/engines.html">Getting Started with Engines</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/initialization.html">Rails 初始化过程</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
    <h4>扩展</h4>
    

<ul>

  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/plugins.html">Rails 插件开发基础</a></li>
    
  
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/rails_on_rack.html">Rails on Rack</a></li>
    
  
    
  
    
  
    
  
    
  


  

  
    
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="http://docs-china.com/rails/generators.html">Creating and Customizing Rails Generators & Templates</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


</ul>

    
</aside>


                </div>
            </div>
        </div>
    </div>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <div>
                <ul class="social">
                    <li class="github">
                        <a href="https://github.com/docs-china/rails/" title="在 GitHub 上关注我们">Github</a>
                    </li>
                    <li class="weibo">
                        <a href="http://weibo.com/docschina" title="关注我们的微博">@DocsChina</a>
                    </li>
                </ul>
            </div>

            <p>本文档授权协议：<a href="http://creativecommons.org/licenses/by-sa/4.0/deed.zh" title="CC BY-SA 4.0">CC BY-SA 4.0</a></p>
        </div>
    </footer>
</body>
</html>
